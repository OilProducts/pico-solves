# #STONKS


I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure!

Spoiler alert: It is.

## Starting from nothing

The challenge provides us with the C code that generated the binary to exploit.  It's not very good (he said, about the deliberately bad code).  Since we have source code an easy first step is to run some static analysis on it.  I loaded up the source in CLion which will automatically run clang-tidy.  There are 13 warnings.  Most of them seem harmless but one sticks out

- Format string is not a string literal (potentially insecure)

The relevant code follows: 

```
char *user_buf = malloc(300 + 1);
printf("What is your API token?\n");
scanf("%300s", user_buf);
printf("Buying stonks with token:\n");
printf(user_buf);
```

The important parts:

1. A 301 byte heap allocation is made to a stack allocated pointer.  
2. scanf reads up to 300 bytes into that memory from the user.
3. printf prints the string.

printf is a variadic function, its first argument is the string to print but that string is parsed to determine how many additional arguments there are.  Those arguments are formatted and inserted into the string before it is displayed.

But we control the entirety of that string.

So if one were to craft a string that will cause printf to make some replacements, you could print all sorts of things.  First I tried %s, but it wasn't very helpful.  A key insight is that printf is always going to be called with just one argument, however we can force it to think that it has many arguments.  Each one will get popped off the stack, interpreted according to the format specifier convention, then inserted into what is eventually displayed.  We can also tell printf to show us the value of a pointer with %p.  The combination of these things mean that if we feed printf a series of repeating "%p" it will keep popping words from the stack and showing us the value.

We have 300 bytes to craft a string, so we can fit a maximum of 150 %p.  It turns out that is way more than enough, 